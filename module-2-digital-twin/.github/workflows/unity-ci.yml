name: Unity Rendering CI

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'src/ch2_unity_rendering/**'
      - '.github/workflows/unity-ci.yml'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'src/ch2_unity_rendering/**'
      - '.github/workflows/unity-ci.yml'

jobs:
  csharp-validation:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '6.0.x'

      - name: Check C# syntax
        run: |
          echo "Validating C# scripts..."
          for cs_file in src/ch2_unity_rendering/scripts/*.cs; do
            echo "Checking $cs_file"
            # Basic syntax validation using Roslyn compiler
            dotnet build-server shutdown
            csc -target:library -nologo -nowarn:CS1701,CS1702 "$cs_file" || {
              echo "✗ Syntax error in $cs_file"
              exit 1
            }
            echo "✓ $cs_file is valid"
          done
        continue-on-error: true

      - name: Lint C# code
        run: |
          pip install cpplint
          echo "Checking code style..."
          # Check for common issues
          for cs_file in src/ch2_unity_rendering/scripts/*.cs; do
            echo "Analyzing $cs_file"

            # Check for TODO/FIXME comments
            if grep -nH "TODO\|FIXME" "$cs_file"; then
              echo "⚠️  Found TODO/FIXME comments in $cs_file"
            fi

            # Check for proper namespace
            if ! grep -q "namespace" "$cs_file"; then
              echo "⚠️  No namespace found in $cs_file"
            fi

            # Check for Unity-specific attributes
            if grep -q "MonoBehaviour\|ScriptableObject" "$cs_file"; then
              if ! grep -q "using UnityEngine" "$cs_file"; then
                echo "✗ Unity script missing 'using UnityEngine' in $cs_file"
                exit 1
              fi
            fi

            echo "✓ $cs_file passed basic checks"
          done

      - name: Validate Unity project structure
        run: |
          echo "Checking Unity project structure..."

          # Check for required directories
          [ -d "src/ch2_unity_rendering/scripts" ] || { echo "✗ Missing scripts directory"; exit 1; }
          [ -d "src/ch2_unity_rendering/ros2_workspace" ] || { echo "✗ Missing ros2_workspace directory"; exit 1; }

          # Check for required files
          [ -f "src/ch2_unity_rendering/scripts/ROSConnection.cs" ] || { echo "✗ Missing ROSConnection.cs"; exit 1; }
          [ -f "src/ch2_unity_rendering/scripts/JointController.cs" ] || { echo "✗ Missing JointController.cs"; exit 1; }
          [ -f "src/ch2_unity_rendering/scripts/TeleopPublisher.cs" ] || { echo "✗ Missing TeleopPublisher.cs"; exit 1; }
          [ -f "src/ch2_unity_rendering/scripts/HumanBehavior.cs" ] || { echo "✗ Missing HumanBehavior.cs"; exit 1; }

          echo "✓ Unity project structure is valid"

      - name: Validate ROS 2 bridge package
        run: |
          echo "Checking ROS 2 bridge package..."

          # Check package.xml exists
          [ -f "src/ch2_unity_rendering/ros2_workspace/src/unity_bridge/package.xml" ] || { echo "✗ Missing package.xml"; exit 1; }

          # Validate package.xml syntax
          xmllint --noout src/ch2_unity_rendering/ros2_workspace/src/unity_bridge/package.xml || { echo "✗ Invalid package.xml"; exit 1; }

          echo "✓ ROS 2 bridge package is valid"

  ros2-bridge-test:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup ROS 2 Humble
        uses: ros-tooling/setup-ros@v0.7
        with:
          required-ros-distributions: humble

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            ros-humble-ros-tcp-endpoint \
            python3-pytest

      - name: Build unity_bridge package
        run: |
          source /opt/ros/humble/setup.bash
          cd src/ch2_unity_rendering/ros2_workspace
          colcon build --packages-select unity_bridge

      - name: Test unity_bridge package
        run: |
          source /opt/ros/humble/setup.bash
          cd src/ch2_unity_rendering/ros2_workspace
          source install/setup.bash
          colcon test --packages-select unity_bridge --event-handlers console_direct+
        continue-on-error: true

      - name: Check launch file syntax
        run: |
          python3 -m py_compile src/ch2_unity_rendering/ros2_workspace/src/unity_bridge/launch/*.py

  documentation-check:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check Unity setup instructions
        run: |
          echo "Validating Unity documentation..."

          # Check README exists
          if [ ! -f "src/ch2_unity_rendering/README.md" ]; then
            echo "⚠️  No README.md found for Unity rendering"
          else
            echo "✓ README.md exists"

            # Check for key sections
            grep -q "Installation" src/ch2_unity_rendering/README.md || echo "⚠️  Missing Installation section"
            grep -q "ROS-TCP-Connector" src/ch2_unity_rendering/README.md || echo "⚠️  Missing ROS-TCP-Connector setup"
            grep -q "Usage" src/ch2_unity_rendering/README.md || echo "⚠️  Missing Usage section"
          fi

      - name: Check C# script documentation
        run: |
          echo "Checking C# script documentation..."

          for cs_file in src/ch2_unity_rendering/scripts/*.cs; do
            # Check for XML documentation comments
            if grep -q "/// <summary>" "$cs_file"; then
              echo "✓ $cs_file has XML documentation"
            else
              echo "⚠️  $cs_file missing XML documentation"
            fi
          done

  integration-validation:
    runs-on: ubuntu-22.04
    needs: [csharp-validation, ros2-bridge-test]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Validate integration completeness
        run: |
          echo "Checking Unity-ROS 2 integration completeness..."

          # Check for both Unity scripts and ROS 2 bridge
          unity_scripts=$(find src/ch2_unity_rendering/scripts -name "*.cs" | wc -l)
          ros2_launch=$(find src/ch2_unity_rendering/ros2_workspace -name "*.launch.py" 2>/dev/null | wc -l)

          echo "Unity C# scripts: $unity_scripts"
          echo "ROS 2 launch files: $ros2_launch"

          if [ "$unity_scripts" -ge 4 ] && [ "$ros2_launch" -ge 1 ]; then
            echo "✓ Integration is complete (scripts: $unity_scripts, launch: $ros2_launch)"
          else
            echo "⚠️  Integration may be incomplete"
          fi

      - name: Summary
        run: |
          echo "==================================================="
          echo "Unity Rendering CI - Summary"
          echo "==================================================="
          echo "✓ C# syntax validation"
          echo "✓ Project structure validation"
          echo "✓ ROS 2 bridge package validation"
          echo "✓ Documentation checks"
          echo "✓ Integration validation"
          echo "==================================================="
          echo "Note: Full Unity Editor testing requires manual validation"
          echo "See docs/module2/chapter2-unity-rendering.mdx for testing instructions"
          echo "==================================================="
