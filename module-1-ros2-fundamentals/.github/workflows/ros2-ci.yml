name: ROS 2 CI - Module 1 Code Examples

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  lint:
    name: Python Linting (ruff)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install ruff
        run: |
          python -m pip install --upgrade pip
          pip install ruff

      - name: Run ruff linter
        run: |
          ruff check src/ --output-format=github

      - name: Run ruff formatter check
        run: |
          ruff format --check src/

  build-and-test:
    name: Build and Test ROS 2 Packages
    runs-on: ubuntu-22.04
    strategy:
      matrix:
        ros_distro: [humble]  # Add 'jazzy' when Ubuntu 24.04 runner available
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up ROS 2 ${{ matrix.ros_distro }}
        uses: ros-tooling/setup-ros@v0.7
        with:
          required-ros-distributions: ${{ matrix.ros_distro }}

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            python3-colcon-common-extensions \
            python3-rosdep \
            ros-${{ matrix.ros_distro }}-gazebo-ros-pkgs \
            ros-${{ matrix.ros_distro }}-turtlebot3 \
            ros-${{ matrix.ros_distro }}-turtlebot3-simulations

      - name: Initialize rosdep
        run: |
          sudo rosdep init || true
          rosdep update

      - name: Install package dependencies
        run: |
          source /opt/ros/${{ matrix.ros_distro }}/setup.bash
          rosdep install --from-paths src --ignore-src -r -y

      - name: Build workspace
        run: |
          source /opt/ros/${{ matrix.ros_distro }}/setup.bash
          colcon build --symlink-install

      - name: Source workspace
        run: |
          source /opt/ros/${{ matrix.ros_distro }}/setup.bash
          source install/setup.bash

      - name: Run Python unit tests (pytest)
        run: |
          source /opt/ros/${{ matrix.ros_distro }}/setup.bash
          source install/setup.bash
          if [ -d "tests" ]; then
            python3 -m pytest tests/ -v
          else
            echo "No tests directory found, skipping pytest"
          fi

      - name: Run ROS 2 launch tests
        run: |
          source /opt/ros/${{ matrix.ros_distro }}/setup.bash
          source install/setup.bash
          colcon test --packages-select-regex "ch[1-5]_.*" || echo "No launch tests found"

      - name: Display test results
        if: always()
        run: |
          source /opt/ros/${{ matrix.ros_distro }}/setup.bash
          source install/setup.bash
          colcon test-result --all --verbose

  code-quality:
    name: Code Quality Checks
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install quality tools
        run: |
          python -m pip install --upgrade pip
          pip install flake8 pep257 mypy

      - name: Run flake8 (PEP 8 compliance)
        run: |
          flake8 src/ --count --select=E9,F63,F7,F82 --show-source --statistics
          flake8 src/ --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics

      - name: Run pep257 (docstring compliance)
        run: |
          pep257 src/ || echo "Docstring warnings found (non-blocking)"

      - name: Check for common security issues
        run: |
          pip install bandit
          bandit -r src/ -ll || echo "Security warnings found (non-blocking)"
